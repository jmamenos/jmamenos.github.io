<!DOCTYPE html>
<!-- html 5 declaration -->
<?php

// Check if cookie exists. If not then set new cookie. Return its value
function getUserCookie() {
  if(isset($_COOKIE['visited'])) {
    // cookie is already set
  } else {
    list($usec, $sec) = explode(" ", microtime()); // Micro time!
    $expire = time()+60*60*24*1000; // expiration after 30 day
    setcookie("visited", "".md5("".$sec.".".$usec."")."", $expire, "/", "", "0"); 
  }
  return $_COOKIE['visited'];
}

/* https://stackoverflow.com/questions/18070154/get-operating-system-info-with-php
*/
$user_agent     =   $_SERVER['HTTP_USER_AGENT'];
function getOS() { 
    global $user_agent;
    $os_platform    =   "Unknown OS Platform";
    $os_array       =   array(
                            '/windows nt 10/i'     =>  'Windows 10',
                            '/windows nt 6.3/i'     =>  'Windows 8.1',
                            '/windows nt 6.2/i'     =>  'Windows 8',
                            '/windows nt 6.1/i'     =>  'Windows 7',
                            '/windows nt 6.0/i'     =>  'Windows Vista',
                            '/windows nt 5.2/i'     =>  'Windows Server 2003/XP x64',
                            '/windows nt 5.1/i'     =>  'Windows XP',
                            '/windows xp/i'         =>  'Windows XP',
                            '/windows nt 5.0/i'     =>  'Windows 2000',
                            '/windows me/i'         =>  'Windows ME',
                            '/win98/i'              =>  'Windows 98',
                            '/win95/i'              =>  'Windows 95',
                            '/win16/i'              =>  'Windows 3.11',
                            '/macintosh|mac os x/i' =>  'Mac OS X',
                            '/mac_powerpc/i'        =>  'Mac OS 9',
                            '/linux/i'              =>  'Linux',
                            '/ubuntu/i'             =>  'Ubuntu',
                            '/iphone/i'             =>  'iPhone',
                            '/ipod/i'               =>  'iPod',
                            '/ipad/i'               =>  'iPad',
                            '/android/i'            =>  'Android',
                            '/blackberry/i'         =>  'BlackBerry',
                            '/webos/i'              =>  'Mobile'
                        );
    foreach ($os_array as $regex => $value) { 
        if (preg_match($regex, $user_agent)) {
            $os_platform    =   $value;
        }
    }   
    return $os_platform;
}

/* https://stackoverflow.com/questions/18070154/get-operating-system-info-with-php
*/
function getBrowser() {
    global $user_agent;
    $browser        =   "Unknown Browser";
    $browser_array  =   array(
                            '/msie/i'       =>  'Internet Explorer',
                            '/firefox/i'    =>  'Firefox',
                            '/safari/i'     =>  'Safari',
                            '/chrome/i'     =>  'Chrome',
                            '/edge/i'       =>  'Edge',
                            '/opera/i'      =>  'Opera',
                            '/netscape/i'   =>  'Netscape',
                            '/maxthon/i'    =>  'Maxthon',
                            '/konqueror/i'  =>  'Konqueror',
                            '/mobile/i'     =>  'Handheld Browser'
                        );
    foreach ($browser_array as $regex => $value) { 
        if (preg_match($regex, $user_agent)) {
            $browser    =   $value;
        }
    }
    return $browser;
}
$user_os        =   getOS();
$user_browser   =   getBrowser();
// stack overflow end

// Initial Run
/*
date_default_timezone_set('America/Los_Angeles');
$visitor = [ 'id' => 1 , 'timestamp' => date('c') , 'page' => getURL() , 'cookie' => getUserCookie() , 'hostname' => gethostbyaddr($_SERVER[REMOTE_ADDR]) , 'info' => fetchInfo()]; 
file_put_contents('visitors/log',"[".json_encode($visitor,JSON_UNESCAPED_SLASHES)."]");
 
*/
function getURL() {
    if (empty($_SERVER['HTTPS'])) {
        $urlString="http://acsweb.ucsd.edu".$_SERVER[REQUEST_URI];
    } 
    else {
        $urlString="https://acsweb.ucsd.edu".$_SERVER[REQUEST_URI];
    }
    return $urlString;
}

function fetchInfo() {
    $allInfo=json_decode(file_get_contents('http://ip-api.com/json/'.$_SERVER['REMOTE_ADDR']));
    global $user_os;
    global $user_browser;
    date_default_timezone_set($allInfo->timezone);
    if (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
        $info=$allInfo->city.", ".$allInfo->regionName.", ".$allInfo->country."<br>Lat: ".$allInfo->lat.", Lon: ".$allInfo->lon."<br>Local time: ".date('g:i:s A')."<br>".$user_os.", ".$user_browser."<br>IP Address (F): ".$_SERVER['HTTP_X_FORWARDED_FOR']."<br>IP Address: ".$_SERVER['REMOTE_ADDR'];
    }
    else {
        $info=$allInfo->city.", ".$allInfo->regionName.", ".$allInfo->country."<br>Lat: ".$allInfo->lat.", Lon: ".$allInfo->lon."<br>Local time: ".date('g:i:s A')."<br>".$user_os.", ".$user_browser."<br>IP Address: ".$_SERVER['REMOTE_ADDR'];
    }
    return $info;
}


// Subsequent Runs 

// This PHP code uploads visitors information to visitors/log 
// It records the date and time in Los Angeles, the page visited, and the IP address 
$inp = file_get_contents('visitors/log'); 

// Setting true fixes double brackets issue 
$visitors = json_decode($inp,'true');

// Finds last index ID to increment next ID 
$lastItem    = end($visitors);
$lastItemID = $lastItem['id'];
date_default_timezone_set("America/Los_Angeles"); // Set to Los Angeles 
$visitor = [ 'id' => $lastItemID + 1 , 'timestamp' => date('c') , 'page' => getURL() , 'cookie' => getUserCookie() , 'hostname' => gethostbyaddr($_SERVER[REMOTE_ADDR]) , 'info' => fetchInfo()]; 
array_push($visitors, $visitor); 

// Set JSON_UNESCAPED_SLASHES is necessary for the double brackets fix 
// May have to chmod 777 all affected directories temporarily 
file_put_contents('visitors/log', json_encode($visitors,JSON_UNESCAPED_SLASHES));

?>
<html>
<head>
	<!-- user-scalable=no fixed undesired zoom issue when selecting input boxes on mobile -->
	<meta content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no" name="viewport">
	<meta charset="utf-8"> <!-- html 5 declaration -->
	<title>Josh's Page</title>
	<link rel="icon" href="favicon.ico?v=4" /> <!-- v=# force refresh favicon !-->
	<style>
	    @import url(//fonts.googleapis.com/css?family=Open+Sans:400,600,700);
	    @import url(//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css); /* import css */
		@import url(//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css);
	    html, body {
	        height: 100%;
	        font-family:'Open Sans', sans-serif; /* sans-serif back-up */
			font-weight:400;
			font-size:calc(14px + 0.1vw);
	    }
		input[type="text"] {
			font-size:calc(14px + 0.1vw);
		}
		/* set width different from default bootstrap 
		 * without altering original bootstrap.css file */ 
		@media (min-width: 1200px) {
			.container {
				max-width: 970px;
			}
		}
		h3 {
			font-weight:600;
			font-size:calc(18px + 0.2vw);
		}
		h2 {
			font-weight:600;
			font-size:calc(22px + 0.3vw);
		}
	</style>
</head>
<body>
	<!-- fill-height and container container-main are wrappers -->
	<div class="fill-height">
		<div class="container container-main">
		<!--
		<div class="row text-center">
			<div class="col-sm-12">
			<h2>Tools</h2>
			<p>One general and several orbital snippets </p> 
			
			</div>
		</div> !--><!-- consider a nav bar for about and making a fun title instead !-->
			<h3>Long Numbers <a data-target="#longNumbers" data-toggle="modal" href="modal" style="background-color:transparent"><i class="fa fa-info-circle fa-lg"></i></a></h3>
			<div aria-labelledby="longNumbersLabel" class="modal fade" id="longNumbers" role="dialog" tabindex="-1"> <!-- aria for assistive and sound extras !-->
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<button aria-label="Close" class="close" data-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title" id="longNumbersLabel">Long Numbers</h4>
						</div>
						<div class="modal-body">
							<p>Make numbers easier to read!</p>
							<p>Adds a space between every 3 integers.</p>
						</div>
						<div class="modal-footer">
							<button class="btn btn-default" data-dismiss="modal" type="button">Close</button>
						</div>
					</div>
				</div>
			</div>
			<p class="lead"></p>
			<div class="row">
				<div class="col-sm-12">
					<!-- myInput and repeat referenced in javascript -->
					<p><input class="form-control" id="myInput" type="number"></p>
					<p id="repeat"></p>
				</div>
			</div>
			<hr>
			<!-- line separator -->
			<h3>Orbital Elements 
			<a data-target="#orbitalElements" data-toggle="modal" href="#" style="background-color:transparent"><i class="fa fa-info-circle fa-lg"></i></a>
			<a data-target="#adjustments" data-toggle="modal" href="#" style="background-color:transparent"><i class="fa fa-sliders fa-lg"></i></a>
			</h3>
			<div aria-labelledby="adjustmentsLabel" class="modal fade" id="adjustments" role="dialog" tabindex="-1">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<button aria-label="Close" class="close" data-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title" id="orbitalElementsLabel">Adjustments </h4>
						</div>
						<div class="modal-body"> <!-- instead of using a modal, try using a hover over and letting the icons appear, with appropriate menu shortcuts in mobile !--> 
							<div class="form-group">
							<label for="decimalPlaces">Specify Decimal Places</label>
							<select onchange="sendValue()" class="form-control" id="decimalPlaces">
							<option value="0">0</option>
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>
							<option value="4" selected="selected">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>
							<option value="9">9</option>
							<option value="10">10</option>
							<option value="11">11</option>
							<option value="12">12</option>
							<option value="13">13</option>
							<option value="14">14</option>
							<option value="15">15</option>
							</select>
							</div>
						</div>
						<script>
						function sendValue() {
							window.dp=parseFloat(document.getElementById("decimalPlaces").value);
							if ($('.inputs:lt(6)').filter(function() {return $.trim($(this).val()).length === 0}).length == 0) {
								orbitalElements();
							}
						}
						</script>
						<div class="modal-footer">
							<button class="btn btn-default" data-dismiss="modal" type="button">Close</button>
						</div>
					</div>
				</div>
			</div>
			<div aria-labelledby="orbitalElementsLabel" class="modal fade" id="orbitalElements" role="dialog" tabindex="-1">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<button aria-label="Close" class="close" data-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title" id="orbitalElementsLabel">Orbital Elements</h4>
						</div>
						<div class="modal-body"> <!-- instead of using a modal, try using a hover over and letting the icons appear, with appropriate menu shortcuts in mobile !--> 
							<p>Calculate classical orbital elements a, e, i, o, w and v.</p> <!-- don't put too much info here, do something else !--> 
							<p>Assumption 1: In this 2 body problem, all bodies are perfect spheres 
							   and no other force than those gravitational are at work. </p> 
							<p>Assumption 2: Orbiting body is much smaller than the planet.</p>
							<p>Assumption 2 Explanation: The assumption states that instead of G(M+m), we have GM 
							   because m is insignificant, where m is the mass of the orbiting body and  
							   M is the mass of the planet. </p>
							<p>If m is significant, then G(M+m) must be used (the remaining equations need to be derived). In the following
							   problems, m is insignificant. </p>
							<p>Units are relative: 1 DU (originally Distance Unit) is typically, 
							   but not always, the radius of the planet.</p>
							<p>1 TU is found from letting mu = 1 DU^3/TU^2. (mu is known)</p>
							<p>Inputs such as 1/3, sqrt(0.5), 0.3^2 and so on, may be entered. </p>
						</div>
						<div class="modal-footer">
							<button class="btn btn-default" data-dismiss="modal" type="button">Close</button>
						</div>
					</div>
				</div>
			</div>
			<p class="lead"></p>
			<div class="row">
				<div class="col-sm-12">
					<div class="input-group">
						<span class="input-group-addon">$\mathtt{r}$</span> <input class="inputs form-control" type="text"> <span class="input-group-btn" style="width:0px"></span> <input class="inputs form-control" type="text"> <span class="input-group-btn" style="width:0px"></span> <input class="inputs form-control" type="text">
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-12">
					<div class="input-group">
						<span class="input-group-addon">$\mathtt{v}$</span> <input class="inputs form-control" type="text"> <span class="input-group-btn" style="width:0px"></span> <input class="inputs form-control" type="text"> <span class="input-group-btn" style="width:0px"></span> <input class="inputs form-control" type="text">
					</div>
				</div>
			</div>
			<div class="row text-center">
				<!-- results referenced with jQuery -->
				<div class="col-sm-6 col-sm-offset-3 results"></div>
				<div class="col-sm-3 debugger"></div>
			</div>
			<div class="row">
				<div class="col-sm-12">
					<!-- canvas referenced in javascript -->
					<div id="canvas"></div>
				</div>
			</div>
			<hr>
			<!-- line separator -->
			<h3>Gibbs Method <a data-target="#gibbsMethod" data-toggle="modal" href="#" style="background-color:transparent"><i class="fa fa-info-circle fa-lg"></i></a></h3>
			<div aria-labelledby="gibbsMethodLabel" class="modal fade" id="gibbsMethod" role="dialog" tabindex="-1">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<button aria-label="Close" class="close" data-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title" id="gibbsMethodLabel">Gibbs Method</h4>
						</div>
						<div class="modal-body">
							<p>Perform all calculations for orbit parameters determination.</p>
						</div>
						<div class="modal-footer">
							<button class="btn btn-default" data-dismiss="modal" type="button">Close</button>
						</div>
					</div>
				</div>
			</div>
			<p class="lead"></p>
			<div class="row">
				<div class="col-sm-12">
					<div class="input-group">
						<span class="input-group-addon">$\mathtt{r_1}$</span> <input class="inputs form-control" type="text"> <span class="input-group-btn" style="width:0px"></span> <input class="inputs form-control" type="text"> <span class="input-group-btn" style="width:0px"></span> <input class="inputs form-control" type="text">
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-12">
					<div class="input-group">
						<span class="input-group-addon">$\mathtt{r_2}$</span> <input class="inputs form-control" type="text"> <span class="input-group-btn" style="width:0px"></span> <input class="inputs form-control" type="text"> <span class="input-group-btn" style="width:0px"></span> <input class="inputs form-control" type="text">
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-12">
					<div class="input-group">
						<span class="input-group-addon">$\mathtt{r_3}$</span> <input class="inputs form-control" type="text"> <span class="input-group-btn" style="width:0px"></span> <input class="inputs form-control" type="text"> <span class="input-group-btn" style="width:0px"></span> <input class="inputs form-control" type="text">
					</div>
				</div>
			</div>
			<div class="row text-center">
				<!-- results referenced with jQuery -->
				<div class="col-sm-6 col-sm-offset-3 results"></div>
				<div class="col-sm-3" id="debugDiv2"></div>
			</div>
			<hr>
			<!-- line separator -->
			<h3>Orbital Change <a data-target="#orbitalChange" data-toggle="modal" href="#" style="background-color:transparent"><i class="fa fa-info-circle fa-lg"></i></a></h3>
			<div aria-labelledby="orbitalChangeLabel" class="modal fade" id="orbitalChange" role="dialog" tabindex="-1">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<button aria-label="Close" class="close" data-dismiss="modal" type="button"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title" id="orbitalChangeLabel">Orbital Change</h4>
						</div>
						<div class="modal-body">
							<p>Perform all calculations for changes between two coplanar 
							   circular orbits with specified e for transfer orbit. </p> 
						</div>
						<div class="modal-footer">
							<button class="btn btn-default" data-dismiss="modal" type="button">Close</button>
						</div>
					</div>
				</div>
			</div>
			<p class="lead"></p>
			<div class="row text-center">
				<div class="col-sm-12">
					<p class="lead"></p>
					<footer>
						<span style="font-weight:600"> 
							<i class="fa fa-copyright fa-lg"></i> Joshua Ma 2017 
							<a href="https://www.linkedin.com/in/jma02/" target="blank">
								<i class="fa fa-linkedin-square fa-lg"></i> LinkedIn
							</a>
						</span> <!-- to do: add Errors? and Github !-->
					</footer>
					<p class="lead"></p>
				</div>
			</div>
		</div>
	</div>
	<script src="https://code.jquery.com/jquery-3.1.0.min.js">
	</script> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.13.3/math.min.js">
	</script> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/85/three.min.js">
	</script> 
	<script type="text/x-mathjax-config">
	      MathJax.Hub.Config({
	          tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]}
	      });
	</script> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML-full">
	</script> 
	<script src="https://threejs.org/examples/js/controls/OrbitControls.js">
	</script> 
	<script src="https://threejs.org/examples/js/renderers/Projector.js">
	</script> 
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js">
	</script>
	<script src="https://acsweb.ucsd.edu/~pjma/20170911/Orbit.js">
	</script>
	<script src="https://acsweb.ucsd.edu/~pjma/20170911/oe.js">
	</script>
	<script src="https://acsweb.ucsd.edu/~pjma/20170911/gm.js">
	</script>
	
	<script>
	
	/** 
	 * Add a space between every DIVIDE numbers 
	 */
	var inputBox = document.getElementById('myInput');
	var DIVIDE = 3;
	inputBox.onkeyup = function() {
		var num = inputBox.value;
		var str = num.toString();
		var sp = " ";
		var str2 = "";
		var str3 = "";
		var ij = 0;
		if (str.length > DIVIDE) {
			for (ii = 0; ii < str.length / DIVIDE; ii++) {
				if (ij < Math.floor(str.length / DIVIDE)) {
					str3 = str.substring(ii * DIVIDE, (ii + 1) * DIVIDE);
					str2 = str2.concat(str3);
					str2 = str2.concat(sp);
					ij++;
				} else {
					str3 = str.substring(ii * DIVIDE, str.length)
					str2 = str2.concat(str3);
				}
			}
		} else {
			str2 = str;
		}
		document.getElementById('repeat').innerHTML = str2;
	}
	/**
	 * Console log an object and its value if applicable  
	 * @author mathjs.org 
	 */
	function print(value) {
		var precision = 14;
		console.log(math.format(value, precision));
	}
	/**
	 * Calculate magnitude of math.js 1x3 matrix 
	 */
	function m(vect) {
		return output = math.sqrt(math.pow(vect.valueOf()[0], 2) + math.pow(vect.valueOf()[1], 2) + math.pow(vect.valueOf()[2], 2));
	}

	</script>
</body>
</html>