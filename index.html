<?php

// Check if cookie exists. If not then set new cookie. Return its value
function getUserCookie() {
  if(isset($_COOKIE['visited'])) {
    // cookie is already set
  } else {
    list($usec, $sec) = explode(" ", microtime()); // Micro time!
    $expire = time()+60*60*24*1000; // expiration after 30 day
    setcookie("visited", "".md5("".$sec.".".$usec."")."", $expire, "/", "", "0"); 
  }
  return $_COOKIE['visited'];
}

/* https://stackoverflow.com/questions/18070154/get-operating-system-info-with-php
*/
$user_agent     =   $_SERVER['HTTP_USER_AGENT'];
function getOS() { 
    global $user_agent;
    $os_platform    =   "Unknown OS Platform";
    $os_array       =   array(
                            '/windows nt 10/i'     =>  'Windows 10',
                            '/windows nt 6.3/i'     =>  'Windows 8.1',
                            '/windows nt 6.2/i'     =>  'Windows 8',
                            '/windows nt 6.1/i'     =>  'Windows 7',
                            '/windows nt 6.0/i'     =>  'Windows Vista',
                            '/windows nt 5.2/i'     =>  'Windows Server 2003/XP x64',
                            '/windows nt 5.1/i'     =>  'Windows XP',
                            '/windows xp/i'         =>  'Windows XP',
                            '/windows nt 5.0/i'     =>  'Windows 2000',
                            '/windows me/i'         =>  'Windows ME',
                            '/win98/i'              =>  'Windows 98',
                            '/win95/i'              =>  'Windows 95',
                            '/win16/i'              =>  'Windows 3.11',
                            '/macintosh|mac os x/i' =>  'Mac OS X',
                            '/mac_powerpc/i'        =>  'Mac OS 9',
                            '/linux/i'              =>  'Linux',
                            '/ubuntu/i'             =>  'Ubuntu',
                            '/iphone/i'             =>  'iPhone',
                            '/ipod/i'               =>  'iPod',
                            '/ipad/i'               =>  'iPad',
                            '/android/i'            =>  'Android',
                            '/blackberry/i'         =>  'BlackBerry',
                            '/webos/i'              =>  'Mobile'
                        );
    foreach ($os_array as $regex => $value) { 
        if (preg_match($regex, $user_agent)) {
            $os_platform    =   $value;
        }
    }   
    return $os_platform;
}

/* https://stackoverflow.com/questions/18070154/get-operating-system-info-with-php
*/
function getBrowser() {
    global $user_agent;
    $browser        =   "Unknown Browser";
    $browser_array  =   array(
                            '/msie/i'       =>  'Internet Explorer',
                            '/firefox/i'    =>  'Firefox',
                            '/safari/i'     =>  'Safari',
                            '/chrome/i'     =>  'Chrome',
                            '/edge/i'       =>  'Edge',
                            '/opera/i'      =>  'Opera',
                            '/netscape/i'   =>  'Netscape',
                            '/maxthon/i'    =>  'Maxthon',
                            '/konqueror/i'  =>  'Konqueror',
                            '/mobile/i'     =>  'Handheld Browser'
                        );
    foreach ($browser_array as $regex => $value) { 
        if (preg_match($regex, $user_agent)) {
            $browser    =   $value;
        }
    }
    return $browser;
}
$user_os        =   getOS();
$user_browser   =   getBrowser();
// stack overflow end

// Initial Run
/*
date_default_timezone_set('America/Los_Angeles');
$visitor = [ 'id' => 1 , 'timestamp' => date('c') , 'page' => getURL() , 'cookie' => getUserCookie() , 'hostname' => gethostbyaddr($_SERVER[REMOTE_ADDR]) , 'info' => fetchInfo()]; 
file_put_contents('visitors/log',"[".json_encode($visitor,JSON_UNESCAPED_SLASHES)."]");
 
*/
function getURL() {
    if (empty($_SERVER['HTTPS'])) {
        $urlString="http://acsweb.ucsd.edu".$_SERVER[REQUEST_URI];
    } 
    else {
        $urlString="https://acsweb.ucsd.edu".$_SERVER[REQUEST_URI];
    }
    return $urlString;
}

function fetchInfo() {
    $allInfo=json_decode(file_get_contents('http://ip-api.com/json/'.$_SERVER['REMOTE_ADDR']));
    global $user_os;
    global $user_browser;
    date_default_timezone_set($allInfo->timezone);
    if (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
        $info=$allInfo->city.", ".$allInfo->regionName.", ".$allInfo->country."<br>Lat: ".$allInfo->lat.", Lon: ".$allInfo->lon."<br>Local time: ".date('g:i:s A')."<br>".$user_os.", ".$user_browser."<br>IP Address (F): ".$_SERVER['HTTP_X_FORWARDED_FOR']."<br>IP Address: ".$_SERVER['REMOTE_ADDR'];
    }
    else {
        $info=$allInfo->city.", ".$allInfo->regionName.", ".$allInfo->country."<br>Lat: ".$allInfo->lat.", Lon: ".$allInfo->lon."<br>Local time: ".date('g:i:s A')."<br>".$user_os.", ".$user_browser."<br>IP Address: ".$_SERVER['REMOTE_ADDR'];
    }
    return $info;
}


// Subsequent Runs 

// This PHP code uploads visitors information to visitors/log 
// It records the date and time in Los Angeles, the page visited, and the IP address 
$inp = file_get_contents('visitors/log'); 

// Setting true fixes double brackets issue 
$visitors = json_decode($inp,'true');

// Finds last index ID to increment next ID 
$lastItem    = end($visitors);
$lastItemID = $lastItem['id'];
date_default_timezone_set("America/Los_Angeles"); // Set to Los Angeles 
$visitor = [ 'id' => $lastItemID + 1 , 'timestamp' => date('c') , 'page' => getURL() , 'cookie' => getUserCookie() , 'hostname' => gethostbyaddr($_SERVER[REMOTE_ADDR]) , 'info' => fetchInfo()]; 
array_push($visitors, $visitor); 

// Set JSON_UNESCAPED_SLASHES is necessary for the double brackets fix 
// May have to chmod 777 all affected directories temporarily 
file_put_contents('visitors/log', json_encode($visitors,JSON_UNESCAPED_SLASHES));

?><!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <meta name="description" content="Calculate classical orbital elements from position and velocity vectors, in relative units (DU and TU). Visualize the orbit data. ">
    <meta name="author" content="Joshua Ma">

    <title>Orbital Elements</title>
	
	<!-- Bootstrap core CSS --> 
    <link href="vendor/bootstrap/css/bootstrap.css" rel="stylesheet">

	<!-- Custom CSS --> 
    <link href="css/simple-sidebar.css" rel="stylesheet">
	
	<link rel="icon" href="favicon.ico">

</head>

<body>

    <div id="wrapper">

        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand"><a href='javascript:$("#wrapper").toggleClass("toggled");'>Close</a></li>
                <li><a href="javascript:$('#aboutModal').modal('toggle');$('#wrapper').toggleClass('toggled');">About</a></li>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper fill-height">
            <div class="container-fluid">
				<div class="row">
					<div class="col-lg-6 b-r">
					
						<p></p>
						<h1>Orbital Elements</h1>
						<p></p>
						
						<div class="row">
							<div class="col-sm-12">
								<div class="input-group">
									<span class="input-group-addon">$\mathtt{r}$</span> 
									<input class="inputs form-control" type="text"> 
									<span class="input-group-btn" style="width:0px">
									</span> <input class="inputs form-control" type="text"> 
									<span class="input-group-btn" style="width:0px"></span> 
									<input class="inputs form-control" type="text">
								</div>
							</div>
						</div>
						
						<div class="row">
							<div class="col-sm-12">
								<div class="input-group">
									<span class="input-group-addon">$\mathtt{v}$</span> 
									<input class="inputs form-control" type="text"> 
									<span class="input-group-btn" style="width:0px"></span> 
									<input class="inputs form-control" type="text"> 
									<span class="input-group-btn" style="width:0px"></span> 
									<input class="inputs form-control" type="text">
								</div>
							</div>
						</div>
						
						<div class="row text-center">
							<div class="col-sm-12">
								<div class="results">
								</div>
							</div>
						</div>
						
						<p></p>
						<a href="#menu-toggle" class="btn btn-secondary btn-margin" id="menu-toggle">Toggle Menu</a>
						<a href="#" class="btn btn-primary btn-margin" id="try-inputs">Try Inputs</a>
						<a href="#" class="btn btn-danger btn-margin" id="clear">Clear</a>
						<a href="#" class="btn btn-info btn-margin" id="options" data-toggle="modal" data-target="#optionsModal">Options</a>
						<p></p>
					</div>
					<div class="col-lg-6 b-r">
						<div id="canvas"></div>
					</div>
				</div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->
	
	<!-- Options Modal -->
	<div class="modal fade" id="optionsModal" tabindex="-1" role="dialog" aria-labelledby="optionsModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="optionsModalLabel">Options</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p>Decimal Places: </p>
					<div data-toggle="buttons">
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="0" autocomplete="off">0</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="1" autocomplete="off">1</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="2" autocomplete="off">2</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="3" autocomplete="off">3</label>
						<label class="btn btn-outline-secondary active"><input type="radio" name="options" value="4" autocomplete="off" checked>4</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="5" autocomplete="off">5</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="6" autocomplete="off">6</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="7" autocomplete="off">7</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="8" autocomplete="off">8</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="9" autocomplete="off">9</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="10" autocomplete="off">10</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="11" autocomplete="off">11</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="12" autocomplete="off">12</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="13" autocomplete="off">13</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="14" autocomplete="off">14</label>
						<label class="btn btn-outline-secondary"><input type="radio" name="options" value="15" autocomplete="off">15</label>
					</div>
					<p>Show the following: </p>
					<div data-toggle="buttons">
						<label class="btn btn-outline-secondary"><input type="checkbox" autocomplete="off">Equations</label>
						<label class="btn btn-outline-secondary"><input type="checkbox" autocomplete="off">Names</label>
						<label class="btn btn-outline-secondary"><input type="checkbox" autocomplete="off">Annotations</label>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<!-- /#options-modal -->
	
	<!-- About Modal -->
	<div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="aboutModalLabel">About</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p>My name is Joshua Ma, and I graduated from UCSD where I majored in Aerospace Engineering. 
					   This is a widget I put together. </p>
					<h5>Credits <small class="text-muted">Links leave current page</small></h5>
					<p>Earth: <a href="http://planetpixelemporium.com/earth.html">Copyright (c) by James Hastings-Trew</a>, <a href="http://planetpixelemporium.com/planets.html">Info</a>. 
					Satellite: <a href="http://flickr.com/people/86624586@N00/">kevinzim / Kevin Walsh</a>, <a href="https://commons.wikimedia.org/wiki/File:Widmanstätten_pattern_kevinzim.jpg">Widmanstätten pattern kevinzim</a>, <a href="https://creativecommons.org/licenses/by/2.0/legalcode">CC BY 2.0</a>.
					Website: <a href="https://github.com/BlackrockDigital/startbootstrap-simple-sidebar">Copyright (c) 2013-2017 Blackrock Digital LLC</a>, <a href="https://opensource.org/licenses/mit-license.php">The MIT License</a>.</p>
					<p>Copyright (c) 2017 Joshua Ma </p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<!-- /#about-modal -->

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/popper/popper.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
	
	<!-- Custom JavaScript -->
    <script src="self/orbital-elements.js"></script>
    <script src="self/orbit.js"></script>
	
	<!-- Math packages --> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.13.3/math.min.js"></script> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML-full"></script> 
	<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
		tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
		"HTML-CSS": {linebreaks:{automatic:true,width:"container"}}
	});
	</script> 
	
	<!-- three.js components --> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/85/three.min.js"></script> 
	<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script> 
	<script src="https://threejs.org/examples/js/renderers/Projector.js"></script> 

    <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
		e.stopPropagation();
        $("#wrapper").toggleClass("toggled");

		$('html').click(function() {
			if($('#wrapper').hasClass("toggled")) {
				$("#wrapper").toggleClass("toggled");
			}
		});

		$('#sidebar-wrapper').click(function(event){
			event.stopPropagation();
		});
    });

    </script>
	
	<!-- Try Inputs Script --> 
	<script>
    $("#try-inputs").click(function() {
		$('.inputs').eq(0).val('3*sqrt(3)/4');
		$('.inputs').eq(1).val('3/4');
		$('.inputs').eq(2).val('0');
		$('.inputs').eq(3).val('-1/(2*sqrt(2))');
		$('.inputs').eq(4).val('sqrt(3)/(2*sqrt(2))');
		$('.inputs').eq(5).val('1/sqrt(2)');
		orbitalElements();
		orbit();
    });
    </script>
	
	<!-- Clear Script --> 
	<script>
    $("#clear").click(function() {
        $('.inputs:lt(6)').val('');
		$('.results').eq(0).empty();
		$('#canvas').empty();
    });
    </script>
	
	<!-- Script Script --> 
	<script> 
	$('.inputs:lt(5)').keydown(function(key) {
		if (key.which === 13) {
			var index = $('.inputs').index(this) + 1;
			$('.inputs').eq(index).select();
		}
	});

	$('.inputs:lt(6)').keyup(function() {
		if ($('.inputs:lt(6)').filter(function() {return $.trim($(this).val()).length === 0}).length == 0) {
			orbitalElements();
			orbit();
		}
	});
	</script> 
	
	<!-- (ﾉ◕ヮ◕)ﾉ*:･ﾟ✧ --> 
	<script> 
	$('input[name=options],input[type=checkbox]').on("change", function() { 
		if ($('.inputs:lt(6)').filter(function() {return $.trim($(this).val()).length === 0}).length == 0) {
			orbitalElements();
		} 
	});
	</script> 
	
	<!-- https://stackoverflow.com/questions/10086693/jquery-resize-on-div-element -->
	<script>
	$.event.special.widthChanged = {
        remove: function() {
            $(this).children('iframe.width-changed').remove();
        },
        add: function () {
            var elm = $(this);
            var iframe = elm.children('iframe.width-changed');
            if (!iframe.length) {
                iframe = $('<iframe/>').addClass('width-changed').prependTo(this);
            }
            var oldWidth = elm.width();
            function elmResized() {
                var width = elm.width();
                if (oldWidth != width) {
                    elm.trigger('widthChanged', [width, oldWidth]);
                    oldWidth = width;
                }
            }

            var timer = 0;
            var ielm = iframe[0];
            (ielm.contentWindow || ielm).onresize = function() {
                clearTimeout(timer);
                timer = setTimeout(elmResized, 20);
            };
        }
    }
	</script>

</body>

</html>
